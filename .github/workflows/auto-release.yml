# Automated Release and PyPI Publishing
# Automatically creates releases and publishes to PyPI on every commit to main

name: Auto Release

on:
    push:
        branches: [main]
        paths:
            - "app/**"
            - "pyproject.toml"
            - "requirements.txt"
    workflow_dispatch:
        inputs:
            version_bump:
                description: "Version bump type"
                required: true
                default: "patch"
                type: choice
                options:
                    - patch
                    - minor
                    - major

permissions:
    contents: write
    id-token: write

env:
    PYTHON_VERSION: "3.11"

jobs:
    # Determine version and create release
    auto-version:
        name: Auto Version & Release
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
            should_release: ${{ steps.check.outputs.should_release }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install versioning tools
              run: |
                  pip install bump2version gitpython

            - name: Check if should release
              id: check
              run: |
                  # Check if this is a merge commit or has [release] in message
                  if [[ "${{ github.event.head_commit.message }}" == *"[release]"* ]] || \
                     [[ "${{ github.event.head_commit.message }}" == *"Merge pull request"* ]] || \
                     [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    echo "should_release=true" >> $GITHUB_OUTPUT
                    echo "âœ… Will create release"
                  else
                    echo "should_release=false" >> $GITHUB_OUTPUT
                    echo "â­ï¸ Skipping release (add [release] to commit message to force)"
                  fi

            - name: Determine version bump
              id: version_bump
              if: steps.check.outputs.should_release == 'true'
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    echo "bump_type=${{ github.event.inputs.version_bump }}" >> $GITHUB_OUTPUT
                  elif [[ "${{ github.event.head_commit.message }}" == *"BREAKING CHANGE"* ]] || \
                       [[ "${{ github.event.head_commit.message }}" == *"[major]"* ]]; then
                    echo "bump_type=major" >> $GITHUB_OUTPUT
                  elif [[ "${{ github.event.head_commit.message }}" == *"feat"* ]] || \
                       [[ "${{ github.event.head_commit.message }}" == *"[minor]"* ]]; then
                    echo "bump_type=minor" >> $GITHUB_OUTPUT
                  else
                    echo "bump_type=patch" >> $GITHUB_OUTPUT
                  fi

            - name: Bump version
              id: version
              if: steps.check.outputs.should_release == 'true'
              run: |
                  # Configure git
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

                  # Get current version from pyproject.toml
                  current_version=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
                  echo "Current version: $current_version"

                  # Bump version
                  bump_type="${{ steps.version_bump.outputs.bump_type }}"
                  pip install bump2version
                  bump2version --current-version $current_version $bump_type pyproject.toml --tag --commit

                  # Get new version
                  new_version=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
                  echo "New version: $new_version"
                  echo "version=$new_version" >> $GITHUB_OUTPUT

                  # Push changes
                  git push origin main --tags

            - name: Generate changelog
              id: changelog
              if: steps.check.outputs.should_release == 'true'
              run: |
                  # Get commits since last tag
                  last_tag=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
                  if [ -z "$last_tag" ]; then
                    commits=$(git log --pretty=format:"- %s (%h)" --no-merges)
                  else
                    commits=$(git log ${last_tag}..HEAD --pretty=format:"- %s (%h)" --no-merges)
                  fi

                  # Create changelog
                  cat > release_notes.md << EOF
                  ## What's Changed

                  $commits

                  ## Installation
                  \`\`\`bash
                  pip install pipex==${{ steps.version.outputs.version }}
                  \`\`\`

                  ## Full Changelog
                  See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
                  EOF

            - name: Create GitHub Release
              if: steps.check.outputs.should_release == 'true'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: PipeX v${{ steps.version.outputs.version }}
                  body_path: release_notes.md
                  draft: false
                  prerelease: false
                  generate_release_notes: true

    # Test and build
    test-and-build:
        name: Test & Build
        runs-on: ubuntu-latest
        needs: auto-version
        if: needs.auto-version.outputs.should_release == 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  ref: v${{ needs.auto-version.outputs.version }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[all,dev]

            - name: Run tests
              run: |
                  pytest tests/ -v --tb=short

            - name: Build distribution
              run: |
                  pip install build
                  python -m build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist-packages
                  path: dist/

    # Publish to PyPI
    publish-pypi:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        needs: [auto-version, test-and-build]
        if: needs.auto-version.outputs.should_release == 'true'
        environment:
            name: pypi
            url: https://pypi.org/p/pipex
        permissions:
            id-token: write
        steps:
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist-packages
                  path: dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/

            - name: Update GitHub Release with PyPI link
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ needs.auto-version.outputs.version }}
                  append_body: true
                  body: |

                      ---

                      ðŸŽ‰ **Successfully published to PyPI!**

                      ðŸ“¦ **Install:** `pip install pipex==${{ needs.auto-version.outputs.version }}`
                      ðŸ”— **PyPI:** https://pypi.org/project/pipex/${{ needs.auto-version.outputs.version }}/

    # Notify success
    notify:
        name: Notify Release
        runs-on: ubuntu-latest
        needs: [auto-version, publish-pypi]
        if: always() && needs.auto-version.outputs.should_release == 'true'
        steps:
            - name: Release notification
              run: |
                  if [ "${{ needs.publish-pypi.result }}" == "success" ]; then
                    echo "ðŸŽ‰ PipeX v${{ needs.auto-version.outputs.version }} successfully released!"
                    echo "ðŸ“¦ PyPI: https://pypi.org/project/pipex/${{ needs.auto-version.outputs.version }}/"
                    echo "ðŸš€ GitHub: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.auto-version.outputs.version }}"
                  else
                    echo "âŒ Release failed for v${{ needs.auto-version.outputs.version }}"
                    exit 1
                  fi

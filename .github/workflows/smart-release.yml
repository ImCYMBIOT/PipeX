# Smart Automated Release using Conventional Commits
# Automatically determines version bumps and creates releases based on commit messages

name: Smart Release

on:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: write
    id-token: write
    pull-requests: write

jobs:
    release:
        name: Smart Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "lts/*"

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install semantic-release
              run: |
                  npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build twine

            - name: Create semantic-release config
              run: |
                  cat > .releaserc.json << 'EOF'
                  {
                    "branches": ["main"],
                    "plugins": [
                      "@semantic-release/commit-analyzer",
                      "@semantic-release/release-notes-generator",
                      "@semantic-release/changelog",
                      [
                        "@semantic-release/exec",
                        {
                          "prepareCmd": "python -c \"import tomllib, tomli_w; config = tomllib.load(open('pyproject.toml', 'rb')); config['project']['version'] = '${nextRelease.version}'; tomli_w.dump(config, open('pyproject.toml', 'wb'))\" && python -m build",
                          "publishCmd": "echo 'Built version ${nextRelease.version}'"
                        }
                      ],
                      [
                        "@semantic-release/git",
                        {
                          "assets": ["pyproject.toml", "CHANGELOG.md"],
                          "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
                        }
                      ],
                      "@semantic-release/github"
                    ]
                  }
                  EOF

            - name: Install tomli-w for version updates
              run: pip install tomli-w

            - name: Run semantic-release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: semantic-release

            - name: Check if release was created
              id: check_release
              run: |
                  if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
                    echo "release_created=true" >> $GITHUB_OUTPUT
                    version=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
                    echo "version=$version" >> $GITHUB_OUTPUT
                  else
                    echo "release_created=false" >> $GITHUB_OUTPUT
                  fi

            - name: Test installation
              if: steps.check_release.outputs.release_created == 'true'
              run: |
                  pip install dist/*.whl
                  pipex --help
                  pipex info

            - name: Publish to PyPI
              if: steps.check_release.outputs.release_created == 'true'
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/

            - name: Update release with PyPI info
              if: steps.check_release.outputs.release_created == 'true'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.check_release.outputs.version }}
                  append_body: true
                  body: |

                      ---

                      ## ðŸ“¦ Installation
                      ```bash
                      pip install pipex==${{ steps.check_release.outputs.version }}
                      ```

                      ## ðŸ”— Links
                      - **PyPI Package:** https://pypi.org/project/pipex/${{ steps.check_release.outputs.version }}/
                      - **Documentation:** https://github.com/${{ github.repository }}/blob/main/README.md
                      - **Changelog:** https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md

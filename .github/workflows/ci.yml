name: CI

on:
    push:
    pull_request:

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: latest
                  virtualenvs-create: true
                  virtualenvs-in-project: true

            - name: Validate pyproject.toml
              run: |
                  python -c "
                  try:
                      import tomllib
                  except ImportError:
                      import tomli as tomllib

                  with open('pyproject.toml', 'rb') as f:
                      config = tomllib.load(f)
                  print('âœ… pyproject.toml is valid')
                  print(f'ðŸ“¦ Building {config[\"tool\"][\"poetry\"][\"name\"]} v{config[\"tool\"][\"poetry\"][\"version\"]}')
                  "

            - name: Install dependencies
              run: poetry install --no-interaction

            - name: Import checks
              run: |
                  poetry run python -c "import app.cli; print('âœ… CLI import successful')"
                  poetry run python -c "import app.default_transforms; print('âœ… Transforms import successful')"
                  poetry run python -c "from app.cli import app; print('âœ… CLI app import successful')"

            - name: CLI smoke test
              run: poetry run pipex --help

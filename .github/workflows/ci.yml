name: CI

on:
    push:
    pull_request:

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: latest
                  virtualenvs-create: true
                  virtualenvs-in-project: true

            - name: Validate pyproject.toml
              run: |
                  python -c "
                  try:
                      import tomllib
                  except ImportError:
                      import tomli as tomllib

                  with open('pyproject.toml', 'rb') as f:
                      config = tomllib.load(f)
                  print('âœ… pyproject.toml is valid')
                  print(f'ğŸ“¦ Building {config[\"tool\"][\"poetry\"][\"name\"]} v{config[\"tool\"][\"poetry\"][\"version\"]}')
                  "

            - name: Install dependencies
              run: poetry install --no-interaction

            - name: Security audit
              run: |
                  # Check for known security vulnerabilities
                  poetry run pip list --format=json | python -c "
                  import json, sys
                  packages = json.load(sys.stdin)
                  print('ğŸ“‹ Installed packages:')
                  for pkg in packages:
                      if pkg['name'] in ['urllib3', 'requests', 'cryptography']:
                          print(f'  {pkg[\"name\"]}: {pkg[\"version\"]}')
                  "

                  # Verify urllib3 version is secure
                  poetry run python -c "
                  import urllib3
                  version = urllib3.__version__
                  major, minor, patch = map(int, version.split('.'))
                  if major > 2 or (major == 2 and minor > 6) or (major == 2 and minor == 6 and patch >= 3):
                      print(f'âœ… urllib3 {version} is secure (>= 2.6.3)')
                  else:
                      print(f'âŒ urllib3 {version} is vulnerable (< 2.6.3)')
                      exit(1)
                  "

            - name: Import checks
              run: |
                  poetry run python -c "import app.cli; print('âœ… CLI import successful')"
                  poetry run python -c "import app.default_transforms; print('âœ… Transforms import successful')"
                  poetry run python -c "from app.cli import app; print('âœ… CLI app import successful')"

            - name: CLI smoke test
              run: poetry run pipex --help

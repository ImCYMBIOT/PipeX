# Auto-format code on push to main branch
name: Auto Format

on:
    push:
        branches: [main]
        paths:
            - "**.py"
    workflow_dispatch:

permissions:
    contents: write
    pull-requests: write

jobs:
    format:
        name: Auto Format Code
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install formatting tools
              run: |
                  python -m pip install --upgrade pip
                  pip install black isort

            - name: Format with black
              run: |
                  black app/ tests/ --line-length 127

            - name: Sort imports with isort
              run: |
                  isort app/ tests/ --profile black --line-length 127

            - name: Check for changes
              id: verify-changed-files
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Commit changes
              if: steps.verify-changed-files.outputs.changed == 'true'
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add .
                  git commit -m "style: auto-format code with black and isort [skip ci]"
                  git push
